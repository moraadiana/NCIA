@model NCIAJobs.Models.Registration
@{
    ViewBag.Title = "ProfileUpdate";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="page-content">
    <!-- BEGIN PAGE BAR -->
    <div class="page-bar">
        <ul class="page-breadcrumb">
            <li>
                <a href="@Url.Action("index", "dashboard")">Home</a>
                <i class="fa fa-circle"></i>
            </li>
            <li>
                <span>Update Personal Details</span>
            </li>
        </ul>
    </div>
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">
            <button class="close" data-close="alert"></button>
            <span> @TempData["Error"] </span>
        </div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success" style="width:100%">
            <button class="close" data-close="alert"></button>
            <span> @TempData["Success"]</span>
        </div>
    }
    <!-- END PAGE BAR -->
    <!-- BEGIN PAGE TITLE-->
    <h1 class="page-title">Update Personal Details</h1>
    <!-- END PAGE TITLE-->
    <!-- END PAGE HEADER-->
    <form action="@Url.Action("profileupdate","dashboard")" method="post">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label>Id Number</label> <span class="text-danger">*</span>
                    <input name="IdNumber" type="number" class="form-control" readonly value="@Model.IdNumber" required minlength="7" maxlength="8" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>First Name</label> <span class="text-danger">*</span>
                    <input name="FirstName" type="text" class="form-control" readonly value="@Model.FirstName" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Middle Name</label>
                    <input name="MiddleName" type="text" class="form-control" readonly value="@Model.MiddleName" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Last Name</label> <span class="text-danger">*</span>
                    <input name="LastName" type="text" class="form-control" readonly value="@Model.LastName" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Date of Birth</label> <span class="text-danger">*</span>
                    <input name="BirthDate" type="date" class="form-control" required id="txtDoB" placeholder="Date of Birth" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Kra Pin No</label> <span class="text-danger">*</span>
                    <input name="KraPin" type="text" class="form-control" required minlength="11" maxlength="11" id="kra-pin" />
                    <span class="text-danger" id="kra-msg"></span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Title</label> <span class="text-danger">*</span>
                    <select class="form-control" name="Title" required>
                        <option value="0">Prof.</option>
                        <option value="1">Dr.</option>
                        <option value="2">Mr.</option>
                        <option value="3">Mrs.</option>
                        <option value="4">Miss.</option>
                        <option value="5">Ms.</option>
                        <option value="6">Rev.</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Gender</label> <span class="text-danger">*</span>
                    <select class="form-control" name="Gender" required>
                        <option value="0">Male</option>
                        <option value="1">Female</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Marital Status</label> <span class="text-danger">*</span>
                    <select class="form-control" name="MaritalStatus" required>
                        <option value="1">Single</option>
                        <option value="2">Married</option>
                        <option value="3">Separated</option>
                        <option value="4">Divorced</option>
                        <option value="5">Widow(er)</option>
                        <option value="6">Other</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Ethnic Origin</label> <span class="text-danger">*</span>
                    <select class="form-control" name="EthnicOrigin" required>
                        <option value="0">African</option>
                        <option value="1">Indian</option>
                        <option value="2">White</option>
                        <option value="3">Coloured</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Nationality</label> <span class="text-danger">*</span>
                    @Html.DropDownListFor(m => m.Nationality, new SelectList(Model.Nationalities, "Code", "Description"), new { @class = "form-control" })
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Ethnicity</label> <span class="text-danger">*</span>
                    @Html.DropDownListFor(m => m.Tribe, new SelectList(Model.Tribes, "Code", "Description"), new { @class = "form-control" })
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Home County</label> <span class="text-danger">*</span>
                    @Html.DropDownListFor(m => m.County, new SelectList(Model.Counties, "Code", "Description"), new { @class = "form-control", id = "counties" })
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Sub County</label> <span class="text-danger">*</span>
                    <select name="SubCounty" class="form-control" id="sub-county" required></select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Constituency</label> <span class="text-danger">*</span>
                    <select name="Constituency" class="form-control" id="constituency" required></select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Postal Code</label> <span class="text-danger">*</span>
                    <input name="PostalCode" type="text" class="form-control" required />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Postal Address</label> <span class="text-danger">*</span>
                    <input name="PostalAddress" type="text" class="form-control" required />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Town/City</label> <span class="text-danger">*</span>
                    <input name="Town" type="text" class="form-control" required />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Telephone No</label> <span class="text-danger">*</span>

                    <input name="TelephoneNo" type="text" class="form-control" required maxlength="10" minlength="10 " id="tel-no"/>
                    <span class="text-danger" id="tel-msg"></span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Mobile No</label> <span class="text-danger">*</span>
                    <input name="MobileNo" type="text" class="form-control" required maxlength="10" minlength ="10 "/>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Email Address</label> <span class="text-danger">*</span>
                    <input name="EmailAddress" type="text" class="form-control" required />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Contact Person Name</label> <span class="text-danger">*</span>
                    <input name="ContactPersonName" type="text" class="form-control" required />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Contact Person Telephone No</label> <span class="text-danger">*</span>
                    <input name="ContactPersonTel" type="text" class="form-control" required />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label>Disability</label> <span class="text-danger">*</span>
                    <select class="form-control" name="Disability" required id="disability">
                        <option value="0">No</option>
                        <option value="1">Yes</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4" id="disability-container">
                <div class="form-group">
                    <label>Nature of Disability</label> <span class="text-danger">*</span>
                    <input name="NatureOfDisability" type="text" class="form-control" id="nature-of-disability" />
                </div>
            </div>
            <div class="col-md-4" id="registration-container">
                <div class="form-group">
                    <label>NCPWD No</label> <span class="text-danger">*</span>
                    <input name="RegistrationNo" type="text" class="form-control" id="registration-no" />
                </div>
            </div>
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary pull-right" onclick="return validateInputs()">Update profile</button>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <input type="checkbox" value="" id="checkbox" /> Do you conset for NCIA to have your personal details?
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    const dateOfBirth = document.getElementById('txtDoB');
    const counties = document.getElementById('counties');
    const subCounties = document.getElementById('sub-county');
    const constituencies = document.getElementById('constituency');
    const disability = document.getElementById('disability');
    const natureOfDisability = document.getElementById('nature-of-disability');
    const registrationNo = document.getElementById('registration-no');
    const disabilityContainer = document.getElementById('disability-container');
    const registrationContainer = document.getElementById('registration-container');
    const checked = document.getElementById('checkbox');
    const kraPin = document.getElementById('kra-pin');
    const kraMsg = document.getElementById('kra-msg');
    const telNo = document.getElementById('tel-no');
    const telMsg = document.getElementById('tel-msg');

    telNo.addEventListener('input', function () {
        const value = telNo.value;
        const numberRegex = /^[0-9]$/;
        
        //if (!numberRegex.test(value) ) {
        //    telMsg.textContent = 'Telephone Number must digits';
        //    return;
        //}
        if ( telNo.length !== 10) {
            telMsg.textContent = 'Telephone Number must be exactly 10 characters long';
            return;
        }
    });


    kraPin.addEventListener('keyup', function () {
        const characterRegex = /^[a-zA-Z]$/;
        const numberRegex = /^[0-9]$/;
        const value = kraPin.value;
        
        kraMsg.textContent = '';
        if (!characterRegex.test(value.charAt(0))) {
            kraMsg.textContent = 'First value must be a character';
            return;
        }

       
        // Validate middle characters
        const middleChars = value.substring(1, value.length - 1);
        for (let i = 0; i < middleChars.length; i++) {
            if (!numberRegex.test(middleChars.charAt(i))) {
                kraMsg.textContent = 'Middle values must be digits';
                return;
            }
        }

        // Validate last character when input is exactly 11 characters
        if (value.length === 11 && !characterRegex.test(value.charAt(value.length - 1))) {
            kraMsg.textContent = 'Last value must be a character';
            return;
        }
        if (value.length !== 11) {
            kraMsg.textContent = 'KRA PIN must be exactly 11 characters long';
            return;
        }

        // If all validations pass
       // kraMsg.textContent = 'Valid KRA PIN';
    });




    const init = function () {
        disabilityContainer.style.display = 'none';
        registrationContainer.style.display = 'none';
    }
    init();

    const disabilitySelected = function () {
        const sel = disability.value;
        if (sel === "1") {
            disabilityContainer.style.display = 'block';
            registrationContainer.style.display = 'block';
            natureOfDisability.setAttribute('required', '');
            registrationNo.setAttribute('required', '');
        } else {
            disabilityContainer.style.display = 'none';
            registrationContainer.style.display = 'none';
            natureOfDisability.removeAttribute('required');
            registrationNo.removeAttribute('required');
        }
    }
    disability.addEventListener('change', disabilitySelected);

    const getConstituencies = async function () {
        const subCounty = subCounties.value;
        const response = await fetch(`/dashboard/getconstituences?subCounty=${subCounty}`);
        const data = await response.json();
        let html = '';
        data.forEach(function (item, i, arr) {
            html += `<option value="${item.Code}">${item.Description}</option>`;
        });
        constituencies.innerHTML = html;
    }
    getConstituencies();
    subCounties.addEventListener('change', getConstituencies);

    const getSubCounties = async function () {
        const county = counties.value;
        const response = await fetch(`/dashboard/getsubcounties?county=${county}`);
        const data = await response.json();
        let html = '';
        data.forEach(function (item, i, arr) {
            html += `<option value="${item.Code}">${item.Description}</option>`;
        });
        subCounties.innerHTML = html;
        getConstituencies();
    }
    getSubCounties();
    counties.addEventListener('change', getSubCounties)

    const validateInputs = function () {

        if (dateOfBirth.value === '') {
            alert('Date of birth cannot be null');
            dateOfBirth.focus();
            return false;
        }
        if (checked.checked === false) {
            alert('Please consent before you continue');
            return false;
        }
    }
</script>

